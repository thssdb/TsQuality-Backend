<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.edu.tsinghua.tsquality.mappers.database.DataQualityMapper">
    <sql id="statColumns">
        min(`min_time`) `minTime`,
        max(`max_time`) `maxTime`,
        sum(`count`) `count`,
        sum(`miss_count`) `missCount`,
        sum(`special_count`) `specialCount`,
        sum(`late_count`) `lateCnt`,
        sum(`redundancy_count`) `redundancyCount`,
        sum(`value_count`) `valueCount`,
        sum(`variation_count`) `variatiCount`,
        sum(`speed_count`) `speedCount`,
        sum(`acceleration_count`) `accelerationCount`
    </sql>
    <sql id="equalPathWhereClause">
        where `path` = #{path}
    </sql>
    <sql id="likePathWhereClause">
        where `path` like concat(#{path}, '.%')
    </sql>

    <select id="selectSeriesStat" resultType="IoTDBSeriesStat">
        select
        <if test="path == null || path.isEmpty()">
            `path`,
        </if>
        <include refid="statColumns"/>
        from series natural join file_series_stats
        <if test="path != null">
            <include refid="equalPathWhereClause">
                <property name="path" value="#{path}"/>
            </include>
        </if>
        <if test="path == null || path.isEmpty()">
            group by `path`
        </if>
    </select>

    <select id="selectDeviceStat" resultType="IoTDBSeriesStat">
        select
        <if test="path == null || path.isEmpty()">
            `device` `path`,
        </if>
        <include refid="statColumns"/>
        from series natural join file_series_stats
        <if test="path != null">
            <include refid="likePathWhereClause">
                <property name="path" value="#{path}"/>
            </include>
        </if>
        <if test="path == null || path.isEmpty()">
            group by `device`
        </if>
    </select>

    <select id="selectDatabaseStat" resultType="IoTDBSeriesStat">
        select
        <if test="path == null || path.isEmpty()">
            `database` `path`,
        </if>
        <include refid="statColumns"/>
        from series natural join file_series_stats
        <if test="path != null">
            <include refid="likePathWhereClause">
                <property name="path" value="#{path}"/>
            </include>
        </if>
        <if test="path == null || path.isEmpty()">
            group by `database`
        </if>
    </select>

    <select id="selectAllStat" resultType="IoTDBSeriesStat">
        select
        <include refid="statColumns" />
        from file_series_stats
    </select>

    <select
            id="getDataQualityAggregationDetailFromFileStats"
            resultType="cn.edu.tsinghua.tsquality.model.entity.SeriesStatWithTime"
    >
        select
        <choose>
            <when test='aggregationType.equals("day")'>
                date_format(from_unixtime(`min_time`/1000), '%Y-%m-%d') `time`,
            </when>
            <when test='aggregationType.equals("month")'>
                date_format(from_unixtime(`min_time`/1000), '%Y-%m') `time`,
            </when>
            <otherwise>
                date_format(from_unixtime(`min_time`/1000), '%Y') `time`,
            </otherwise>
        </choose>
        <include refid="statColumns" />
        from series natural join file_series_stats
        <include refid="equalPathWhereClause" />
    </select>
</mapper>
